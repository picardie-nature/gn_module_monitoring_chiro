{
  "geometry_type": "Point",
  "display_properties": [
    "base_site_name",
    "base_site_code",
    "type_site_chiro_lvl1",
    "type_site_chiro_lvl2",
    "site_temoin",
    "site_refuge",
    "code_site_parent",
    "id_inventor",
    "first_use_date",
    "acces_site",
    "contraintes_prospe",
    "type_proprietaire",
    "gestionnaire",
    "base_site_description",
    "hybrid_last_visit",
    "hybrid_nb_visit",
    "hybrid_prospe_duration",
    "hybrid_effectif_max_site",
    "hybrid_n_taxon_site",
    "hybrid_site_activities"
  ],
  "display_list": [
    "base_site_code",
    "display_type_site_chiro",
    "hybrid_last_visit",
    "hybrid_effectif_max_site",
    "hybrid_n_taxon_site",
    "hybrid_site_activities"
  ],
  "sorts": [
    {"prop": "hybrid_last_visit", "dir": "desc"}
  ],
  "specific": {
    "base_site_code": {
      "type_widget": "text",
      "attribut_label": "Code",
      "hidden": true
    },
    "id_nomenclature_type_site": {
      "type_widget": "text",
      "type_util": "nomenclature",
      "attribut_label": "Type site",
      "doc": "Type de site selon la nomenclature GN, obligatoire dans t_base_site. Toujours à 'Site chiroptère'.",
      "value": {
        "code_nomenclature_type": "TYPE_SITE",
        "cd_nomenclature": "CHI"
      },
      "required": true,
      "hidden": true
    },
    "display_type_site_chiro": {
      "type_widget": "text",
      "type_util": "nomenclature",
      "attribut_label": "Type de gîte",
      "doc": "Type de gîte le plus précis renseigné, alimenté automatiquement à partir des champs lvl1/lvl2. Utilisé pour affichage dans la liste des sites, masqué dans le formulaire et la fiche du site.",
      "hidden": true
    },
    "type_site_chiro_lvl1": {
      "type_widget": "datalist",
      "attribut_label": "Type de gîte (niveau 1)",
      "api": "nomenclatures/nomenclature/TYPE_GITE_CHIRO",
      "application": "GeoNature",
      "keyValue": "id_nomenclature",
      "keyLabel": "label_fr",
      "data_path": "values",
      "type_util": "nomenclature",
      "required": true,
      "filters": {
        "cd_nomenclature": ["0100", "0200", "0300", "0400", "0500", "0600", "0700", "0800"]
      }
    },
    "type_site_chiro_lvl2": {
      "type_widget": "datalist",
      "attribut_label": "Type de gîte (niveau 2)",
      "api": "nomenclatures/nomenclature/TYPE_GITE_CHIRO",
      "application": "GeoNature",
      "keyValue": "id_nomenclature",
      "keyLabel": "label_fr",
      "data_path": "values",
      "type_util": "nomenclature",
      "required": false,
      "hidden": [
        "({value, meta}) => {",
          "var no_lvl2 = [null, '0200', '0300', '0800'];",
          "var type_site_lvl1 = meta.nomenclatures[value.type_site_chiro_lvl1] || {};",
          "return value.type_site_chiro_lvl1 === null || no_lvl2.includes(type_site_lvl1.cd_nomenclature)",
        "}"
      ],
      "filters": [
        "({value, meta}) => {",
          "var type_site_lvl1 = meta.nomenclatures[value.type_site_chiro_lvl1] || {};",
          "if ((type_site_lvl1).cd_nomenclature == '0100') {",
            "return {cd_nomenclature: ['0101', '0102', '0103', '0104']}",
          "} else if ((type_site_lvl1).cd_nomenclature == '0400') {",
            "return {cd_nomenclature: ['0401', '0402', '0403', '0404']}",
          "} else if ((type_site_lvl1).cd_nomenclature == '0500') {",
            "return {cd_nomenclature: ['0501', '0502', '0503', '0504', '0505', '0506', '0507', '0508', '0509', '0510', '0511', '0512', '0513', '0514', '0515', '0516', '0517', '0518']}",
          "} else if ((type_site_lvl1).cd_nomenclature == '0600') {",
            "return {cd_nomenclature: ['0601', '0602', '0603', '0604', '0605', '0606', '0607', '0608']}",
          "} else if ((type_site_lvl1).cd_nomenclature == '0700') {",
            "return {cd_nomenclature: ['0701', '0702', '0703', '0704', '0707']}",
          "}",
        "}"
      ]
    },
    "site_temoin": {
      "type_widget": "select",
      "attribut_label": "Site témoin",
      "values": [
        "Oui",
        "Non"
      ],
      "hidden": true,
      "default": "Non",
      "required": false
    },
    "site_refuge": {
      "type_widget": "select",
      "attribut_label": "Site labellisé refuge",
      "values": [
        "Oui",
        "Non"
      ],
      "hidden": true,
      "default": "Non",
      "required": false
    },
    "code_site_parent": {
      "type_widget": "text",
      "attribut_label": "Entrée principale",
      "definition": "Code de l'entrée principale, si ce site est une entrée secondaire. Merci de saisir votre visite dans le site correspondant à l'entrée principale."
    },
    "acces_site": {
      "type_widget": "datalist",
      "attribut_label": "Conditions d'accès",
      "definition": "Est-ce que l'accès au site est possible physiquement sans l'autorisation du propriétaire ?",
      "api": "nomenclatures/nomenclature/CONDITIONS_ACCES",
      "application": "GeoNature",
      "keyValue": "id_nomenclature",
      "keyLabel": "label_fr",
      "data_path": "values",
      "type_util": "nomenclature",
      "required": true,
      "filters": {
        "cd_nomenclature": [
          "Sans autorisation",
          "Sur autorisation"
        ]
      }
    },
    "contraintes_prospe": {
      "type_widget": "datalist",
      "attribut_label": "Contraintes de prospection",
      "definition": "Détails concernant les contraintes liées à l'accès à la prospection",
      "api": "nomenclatures/nomenclature/CONTRAINTES_PROSPECTION",
      "application": "GeoNature",
      "keyValue": "id_nomenclature",
      "keyLabel": "label_fr",
      "data_path": "values",
      "type_util": "nomenclature",
      "required": false,
      "multiple": false
    },
    "type_proprietaire": {
      "type_widget": "datalist",
      "attribut_label": "Type de propriétaire",
      "definition": "Type de propriétaire du site",
      "api": "nomenclatures/nomenclature/TYPE_PROPRIETAIRE",
      "application": "GeoNature",
      "keyValue": "id_nomenclature",
      "keyLabel": "label_fr",
      "data_path": "values",
      "type_util": "nomenclature",
      "default": {
        "cd_nomenclature": "Non renseigné"
      },
      "required": false,
      "multiple": false
    },
    "gestionnaire": {
      "type_widget": "datalist",
      "attribut_label": "Gestionnaire",
      "definition": "Gestionnaire, à prévenir avant d'aller sur site",
      "api": "nomenclatures/nomenclature/GESTIONNAIRE",
      "application": "GeoNature",
      "keyValue": "id_nomenclature",
      "keyLabel": "label_fr",
      "data_path": "values",
      "type_util": "nomenclature",
      "default": {
        "cd_nomenclature": "Non renseigné"
      },
      "required": false,
      "multiple": false
    },
    "base_site_description": {
      "attribut_label": "Description du site"
    },
    "hybrid_last_visit": {
      "type_widget": "date",
      "attribut_label": "Date de la dernière visite (PicNat ou CEN)",
      "hidden": true,
      "required": false
    },
    "hybrid_nb_visit": {
      "type_widget": "integer",
      "attribut_label": "Nombre de visites (PicNat et CEN)",
      "hidden": true,
      "required": false
    },
    "hybrid_prospe_duration": {
      "type_widget": "text",
      "attribut_label": "Temps de prospection",
      "hidden": true,
      "required": false
    },
    "hybrid_effectif_max_site": {
      "type_widget": "number",
      "attribut_label": "Effectif max. (chiro)",
      "hidden": true,
      "required": false
    },
    "hybrid_n_taxon_site": {
      "type_widget": "number",
      "attribut_label": "Nbre de taxons (chiro)",
      "hidden": true,
      "required": false
    },
    "hybrid_site_activities": {
      "type_widget": "text",
      "attribut_label": "Activités constatées",
      "hidden": true,
      "required": false
    }
  },
  "change": [
    "({objForm}) => {",
      "objForm.patchValue({",
        "display_type_site_chiro: objForm.value.type_site_chiro_lvl2 || objForm.value.type_site_chiro_lvl1",
      "});",
    "}",
    ""
  ]
}
